"use strict";var topCanvas=document.getElementById("top");topCanvas.width=window.innerWidth;var sideLength=topCanvas.width/16;topCanvas.height=1.5*sideLength;var topCtx=topCanvas.getContext("2d");topCtx.fillStyle="#ffffff",topCtx.globalAlpha=.35;var bottomCanvas=document.getElementById("bottom");bottomCanvas.width=window.innerWidth,bottomCanvas.height=1.25*sideLength;var bottomCtx=bottomCanvas.getContext("2d");bottomCtx.fillStyle="#ffffff",bottomCtx.globalAlpha=.35;var backgroundCanvas=document.getElementById("background");backgroundCanvas.width=window.innerWidth,backgroundCanvas.height=window.innerHeight;var backgroundCtx=backgroundCanvas.getContext("2d");backgroundCtx.fillStyle="#ccccff";var backgroundColors=[[176,23,31],[205,16,118],[148,0,211],[0,0,139],[0,128,128],[46,139,87],[0,100,0],[85,107,47],[238,118,0],[255,69,0]],bgcLength=backgroundColors.length,foregroundColors=[[220,20,60],[255,105,180],[224,102,255],[67,110,238],[32,178,170],[78,238,148],[0,205,0],[107,142,35],[255,165,79],[255,125,64]],fgcLength=foregroundColors.length,currentBackgroundColor=[255,255,255],currentForegroundColor=[255,255,255],nextBackgroundColor=[255,255,255],nextForegroundColor=[255,255,255],reachedNextColor=!0,xCells=Math.floor(topCanvas.width/sideLength),updateCount=0,chordNotes=[],chordBeats=[],beatLength=.25,attackLength=.05,decayLength=.05,beatLengthSelect=document.getElementById("beatLengthSelect"),cell={x:0,alive:!1,nextState:"undefined"},cells=[],cells2=[],selectedCell=0,tune=void 0,tuna=void 0,convolver=void 0,audioCtx=void 0,scale="chin_lusheng",scaleSelect=document.getElementById("scaleSelect"),baseNote=110,frequencySelect=document.getElementById("frequencySelect"),fadeDiv=document.getElementById("fadeable"),fadeOpacity=1,mouseLastMoved=void 0,init=function(){for(var e=0;xCells>e;e++){var t=Object.create(cell),a=Object.create(cell);t.x=e,a.x=e,Math.random()>.5&&(t.alive=!0),Math.random()>.5&&(a.alive=!0),cells[e]=t,cells2[e]=a,0==e?a.alive&&chordBeats.push(e):a.alive&&!cells2[e-1].alive&&chordBeats.push(e)}initTune(),mouseLastMoved=Date.now()},initTune=function(){tune=new Tune,tune.loadScale(scale),tune.tonicize(baseNote),audioCtx=new AudioContext,tuna=new Tuna(audioCtx),convolver=new tuna.Convolver({highCut:22050,lowCut:20,dryLevel:1,wetLevel:1.5,level:1,impulse:"tuna/impulses/impulse_pistol.wav",bypass:0})},update=function(e){chordNotes=[];for(var t=0;xCells>t;t++)0==t?cells[xCells-1].alive!=(cells[t].alive||cells[t+1].alive)?cells[t].nextState="living":cells[t].nextState="dead":t==xCells-1?cells[t-1].alive!=(cells[t].alive||cells[0].alive)?cells[t].nextState="living":cells[t].nextState="dead":cells[t-1].alive!=(cells[t].alive||cells[t+1].alive)?cells[t].nextState="living":cells[t].nextState="dead";for(var a=0;xCells>a;a++)"living"==cells[a].nextState?(cells[a].alive=!0,cells[a-1]?Math.random()<.2?chordNotes.push(a):cells[a-1].alive?cells[a-2]&&cells[a-1].alive&&cells[a-2].alive&&Math.random()<.3&&chordNotes.push(a):chordNotes.push(a):chordNotes.push(a)):cells[a].alive=!1,cells[a].nextState="undefined";for(var l=0;l<chordNotes.length;l++)playNote(chordNotes[l],e*beatLength,.025,attackLength,decayLength,0);draw()},update2=function(){chordBeats=[];for(var e=0;xCells>e;e++)0==e?cells2[xCells-1].alive!=(cells2[e].alive||cells2[e+1].alive)?cells2[e].nextState="living":cells2[e].nextState="dead":e==xCells-1?cells2[e-1].alive!=(cells2[e].alive||cells2[0].alive)?cells2[e].nextState="living":cells2[e].nextState="dead":cells2[e-1].alive!=(cells2[e].alive||cells2[e+1].alive)?cells2[e].nextState="living":cells2[e].nextState="dead";for(var t=0;xCells>t;t++)"living"==cells2[t].nextState?cells2[t].alive=!0:cells2[t].alive=!1,cells2[t].nextState="undefined";for(var a=0;xCells>a;a++)0==a?cells2[a].alive&&chordBeats.push(a):cells2[a].alive&&!cells2[a-1].alive&&chordBeats.push(a)},draw=function(){topCtx.clearRect(0,0,topCanvas.width,topCanvas.height);for(var e=0;xCells>e;e++)cells[e].alive&&chordNotes.includes(e)&&topCtx.fillRect(e*sideLength,0,sideLength,sideLength);updateCount++;for(var t=0;xCells>t;t++)topCtx.font="18px Helvetica",topCtx.globalAlpha=.4,topCtx.fillText(parseInt(tune.note(t)),t*sideLength+10,sideLength+20),topCtx.globalAlpha=.35;shaders()},draw2=function(){bottomCtx.clearRect(0,0,bottomCanvas.width,bottomCanvas.height);for(var e=0;xCells>e;e++)cells2[e].alive&&bottomCtx.fillRect(e*sideLength,bottomCanvas.height-sideLength-2,sideLength,sideLength);for(var t=0;xCells>t;t++)t==selectedCell&&(bottomCtx.lineWidth=2,bottomCtx.strokeStyle="#ff0000",bottomCtx.strokeRect(t*sideLength,bottomCanvas.height-sideLength-2,sideLength,sideLength));chordBeats.includes(selectedCell)&&update(findChordLength(selectedCell)),selectedCell++,selectedCell>=xCells&&(update2(),selectedCell=0)},shaders=function(){if(reachedNextColor){var e=getRandomBackgroundColor();nextBackgroundColor=backgroundColors[e],nextForegroundColor=foregroundColors[e],reachedNextColor=!1}currentBackgroundColor=lerpTowardColor(currentBackgroundColor,nextBackgroundColor),currentForegroundColor=lerpTowardColor(currentForegroundColor,nextForegroundColor);for(var t=currentForegroundColor[0]+(Math.floor(17*Math.random())-16),a=currentForegroundColor[1]+(Math.floor(17*Math.random())-16),l=currentForegroundColor[2]+(Math.floor(17*Math.random())-16),o=[t,a,l],n=currentBackgroundColor[0]+(Math.floor(17*Math.random())-16),r=currentBackgroundColor[1]+(Math.floor(17*Math.random())-16),c=currentBackgroundColor[2]+(Math.floor(17*Math.random())-16),i=[n,r,c],d=0;d<window.innerWidth;d+=10)for(var s=0;s<window.innerHeight;s+=10){var u=Math.floor(d/(window.innerWidth/16));cells[u].alive&&chordNotes.includes(u)?(backgroundCtx.fillStyle=rgbToHex(o[0],o[1],o[2]),backgroundCtx.fillRect(d,s,20*Math.random(),20*Math.random())):Math.random()<.4&&(backgroundCtx.fillStyle=rgbToHex(i[0],i[1],i[2]),backgroundCtx.fillRect(d,s,20*Math.random(),20*Math.random()))}},componentToHex=function(e){var t=e.toString(16);return 1==t.length?"0"+t:t},getRandomBackgroundColor=function(){var e=Math.floor(Math.random()*bgcLength);return e},lerpTowardColor=function(e,t){var a=e;if(e[0]==t[0]&&e[1]==t[1]&&e[2]==t[2])return reachedNextColor=!0,a;for(var l=0;3>l;l++)e[l]<t[l]?a[l]++:e[l]>t[l]&&a[l]--;return a},rgbToHex=function(e,t,a){return"#"+componentToHex(e)+componentToHex(t)+componentToHex(a)},fadeCanvas=function(){},fadeText=function(){fadeDiv.style.opacity=fadeOpacity,fadeDiv.style.filter="alpha(opacity="+100*fadeOpacity+")",Date.now()-mouseLastMoved>1e3&&(fadeOpacity-=.025),0>fadeOpacity&&(fadeOpacity=0)},findChordLength=function(e){for(var t=1,a=!1;!a;)e+t<cells2.length&&cells2[e+t].alive?t++:a=!0;return t},playNote=function(e,t,a,l,o,n){var r=audioCtx.createOscillator();r.type="triangle",r.frequency.value=tune.note(e),l+o>t&&(l=l/o*(o*(t/2)),o=t-l);var c=audioCtx.createGain();c.gain.setValueAtTime(0,audioCtx.currentTime),c.gain.linearRampToValueAtTime(a,audioCtx.currentTime+l),c.gain.linearRampToValueAtTime(a,audioCtx.currentTime+t-o),c.gain.linearRampToValueAtTime(0,audioCtx.currentTime+t),r.connect(c),c.connect(convolver),convolver.connect(audioCtx.destination),r.start(),r.stop(audioCtx.currentTime+t)};window.onload=init;var interval=setInterval(draw2,1e3*beatLength),interval2=setInterval(shaders,Math.random()*beatLength*3e3),interval3=setInterval(fadeCanvas,1e3/180/(beatLength/5)),interval4=setInterval(fadeText,100);document.onmousemove=function(){fadeOpacity=1,mouseLastMoved=Date.now()},scaleSelect.onchange=function(){tune.loadScale(scaleSelect.value)},frequencySelect.onchange=function(){tune.tonicize(parseInt(frequencySelect.value))},beatLengthSelect.onchange=function(){beatLength=parseFloat(beatLengthSelect.value),clearInterval(interval),clearInterval(interval2),clearInterval(interval3),interval=setInterval(draw2,1e3*beatLength),interval2=setInterval(shaders,Math.random()*beatLength*1500),interval3=setInterval(fadeCanvas,beatLength*(1e3/180))},attackLengthSelect.onchange=function(){attackLength=parseFloat(attackLengthSelect.value)},decayLengthSelect.onchange=function(){decayLength=parseFloat(decayLengthSelect.value)};