"use strict";var topCanvas=document.getElementById("top");topCanvas.width=window.innerWidth;var sideLength=topCanvas.width/16;topCanvas.height=1.5*sideLength;var topCtx=topCanvas.getContext("2d");topCtx.fillStyle="#000000";var bottomCanvas=document.getElementById("bottom");bottomCanvas.width=window.innerWidth,bottomCanvas.height=1.25*sideLength;var bottomCtx=bottomCanvas.getContext("2d");bottomCtx.fillStyle="#000000";var xCells=Math.floor(topCanvas.width/sideLength),updateCount=0,chordNotes=[],chordBeats=[],beatLength=.25,attackLength=.05,decayLength=.05,beatLengthSelect=document.getElementById("beatLengthSelect"),cell={x:0,alive:!1,nextState:"undefined"},cells=[],cells2=[],selectedCell=0,tune=void 0,tuna=void 0,convolver=void 0,audioCtx=void 0,scale="chin_lusheng",scaleSelect=document.getElementById("scaleSelect"),baseNote=110,frequencySelect=document.getElementById("frequencySelect"),init=function(){for(var e=0;xCells>e;e++){var t=Object.create(cell),l=Object.create(cell);t.x=e,l.x=e,Math.random()>.5&&(t.alive=!0),Math.random()>.5&&(l.alive=!0),cells[e]=t,cells2[e]=l,0==e?l.alive&&chordBeats.push(e):l.alive&&!cells2[e-1].alive&&chordBeats.push(e)}initTune()},initTune=function(){tune=new Tune,tune.loadScale(scale),tune.tonicize(baseNote),audioCtx=new AudioContext,tuna=new Tuna(audioCtx),convolver=new tuna.Convolver({highCut:22050,lowCut:20,dryLevel:1,wetLevel:1.5,level:1,impulse:"tuna/impulses/impulse_rev.wav",bypass:0})},update=function(e){chordNotes=[];for(var t=0;xCells>t;t++)0==t?cells[xCells-1].alive!=(cells[t].alive||cells[t+1].alive)?cells[t].nextState="living":cells[t].nextState="dead":t==xCells-1?cells[t-1].alive!=(cells[t].alive||cells[0].alive)?cells[t].nextState="living":cells[t].nextState="dead":cells[t-1].alive!=(cells[t].alive||cells[t+1].alive)?cells[t].nextState="living":cells[t].nextState="dead";for(var l=0;xCells>l;l++)"living"==cells[l].nextState?(cells[l].alive=!0,chordNotes.push(l)):cells[l].alive=!1,cells[l].nextState="undefined";for(var a=0;a<chordNotes.length;a++)playNote(chordNotes[a],e*beatLength,.05,attackLength,decayLength,0);draw()},update2=function(){chordBeats=[];for(var e=0;xCells>e;e++)0==e?cells2[xCells-1].alive!=(cells2[e].alive||cells2[e+1].alive)?cells2[e].nextState="living":cells2[e].nextState="dead":e==xCells-1?cells2[e-1].alive!=(cells2[e].alive||cells2[0].alive)?cells2[e].nextState="living":cells2[e].nextState="dead":cells2[e-1].alive!=(cells2[e].alive||cells2[e+1].alive)?cells2[e].nextState="living":cells2[e].nextState="dead";for(var t=0;xCells>t;t++)"living"==cells2[t].nextState?cells2[t].alive=!0:cells2[t].alive=!1,cells2[t].nextState="undefined";for(var l=0;xCells>l;l++)0==l?cells2[l].alive&&chordBeats.push(l):cells2[l].alive&&!cells2[l-1].alive&&chordBeats.push(l)},draw=function(){topCtx.clearRect(0,0,topCanvas.width,topCanvas.height);for(var e=0;xCells>e;e++)cells[e].alive&&topCtx.fillRect(e*sideLength,0,sideLength,sideLength);updateCount++;for(var t=0;xCells>t;t++)topCtx.font="18px Helvetica",topCtx.fillText(parseInt(tune.note(t)),t*sideLength+10,sideLength+20)},draw2=function(){bottomCtx.clearRect(0,0,bottomCanvas.width,bottomCanvas.height);for(var e=0;xCells>e;e++)cells2[e].alive&&bottomCtx.fillRect(e*sideLength,bottomCanvas.height-sideLength-2,sideLength,sideLength);for(var t=0;xCells>t;t++)t==selectedCell&&(bottomCtx.lineWidth=2,bottomCtx.strokeStyle="#ff0000",bottomCtx.strokeRect(t*sideLength,bottomCanvas.height-sideLength-2,sideLength,sideLength));chordBeats.includes(selectedCell)&&update(findChordLength(selectedCell)),selectedCell++,selectedCell>=xCells&&(update2(),selectedCell=0)},findChordLength=function(e){for(var t=1,l=!1;!l;)e+t<cells2.length&&cells2[e+t].alive?t++:l=!0;return t},playNote=function(e,t,l,a,n,i){var c=audioCtx.createOscillator();c.type="triangle",c.frequency.value=tune.note(e),a+n>t&&(a=a/n*(n*(t/2)),n=t-a);var o=audioCtx.createGain();o.gain.setValueAtTime(0,audioCtx.currentTime),o.gain.linearRampToValueAtTime(l,audioCtx.currentTime+a),o.gain.linearRampToValueAtTime(l,audioCtx.currentTime+t-n),o.gain.linearRampToValueAtTime(0,audioCtx.currentTime+t),c.connect(o),o.connect(convolver),convolver.connect(audioCtx.destination),c.start(),c.stop(audioCtx.currentTime+t)};window.onload=init;var interval=setInterval(draw2,1e3*beatLength);scaleSelect.onchange=function(){tune.loadScale(scaleSelect.value)},frequencySelect.onchange=function(){tune.tonicize(parseInt(frequencySelect.value))},beatLengthSelect.onchange=function(){beatLength=parseFloat(beatLengthSelect.value),clearInterval(interval),interval=setInterval(draw2,1e3*beatLength)},attackLengthSelect.onchange=function(){attackLength=parseFloat(attackLengthSelect.value)},decayLengthSelect.onchange=function(){decayLength=parseFloat(decayLengthSelect.value)};